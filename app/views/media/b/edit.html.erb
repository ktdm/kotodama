<%- @title = "Edit " + @_media.data_type.downcase + " '" + @_media.title + "'" -%>
<% content_for :head do -%>
<script type="text/javascript">
function toggle_frames(it) {
 for (i in eddisp.frames) if ($(eddisp.frames[i]).style.display!=="none") break;
 if (eddisp.menu[i]==it) return false;
 $(eddisp.frames[i]).style.display="none";
 $(eddisp.frames[j=eddisp.menu.indexOf(it)]).style.display=eddisp.display[j];
 if (eddisp.finalfunc) eddisp.finalfunc(it);
 return eddisp.frames[i];
}
var eddisp={
 frames:["mediatype_render_frame","mediatype_script_frame","mediatype_signature_frame"],
 menu:["Render","Code","Type"],
 display:["block","block","block"],
 finalfunc:function(a){ //FIXME being done twice...
  $("argument_operations").style.display=(a==="Type"?"block":"none");
  if (a==="Render") $("mediatype_render").src = window.location.href.replace(/^.*\//, '/')
 }
};
var lists={
 signature_container: {
  insfunc: function(){
   var d,i,n=0;
   for (i=0;i<this.actions.length;i++) {
    d=this.actions[i].firstChild.id;
    n=Math.max(n,parseFloat(d.slice(4))) //avoid collisions
   }
   n++;
   this.target.appendChild($("argument_stamp").cloneNode(true)).setAttribute("id","arg_"+n);
   (h=$("arg_"+n).childNodes[1].childNodes[1]).childNodes[1].innerHTML=this.insname;
   h.lastChild.value=this.insname;
   h.childNodes[3].style.display="none";
   h.childNodes[4].style.display="inline";
   h.childNodes[4].focus();
   $("arg_"+n).getElementsByClassName("view")[0].onmousedown=viewlinks
  },
  finalfunc: arity_display
 }
};

function arity_display(n) {
 var i=1;
 while (!(target=$("arg_"+n))&&i!=1000) {
  n+=2*i*(i%2)-i; //1D spiral search (for del)
  i++
 }
 var a=new List((sublist=target.parentNode.parentNode).id);
 if (a.length===1) {sublist.previousSibling.previousSibling.style.display="none"}
 else sublist.previousSibling.previousSibling.style.display="block";
 if ((f=sublist.firstChild.firstChild).firstChild.innerHTML==="\u2193") f.removeChild(f.firstChild);
 if (f!==target&&target.firstChild.innerHTML!=="\u2193") {
  target.insertBefore(document.createElement("div"),target.firstChild).setAttribute("class","arrow");
  target.firstChild.innerHTML="&darr;"
 }
}
</script>
<style type="text/css">
#argument_operations {
 display:none;
 float:right;
 border-right:1px solid black;
 margin-right:20px
}
#mediatype_editor_menu {
 float:right
}
#argument_stamp,#ins_stamp {
 display:none
}
#mediatype_signature_frame {
 padding:0px 20px 0px 20px;
 max-height:100%;
 overflow:auto
}
#ins_item {
 clear:left
}
#signature_container li {
 width:60%;
 margin:20px
}
#signature_container li:only-child {
 margin:0px;
}
.arrow {
 text-align:center;
 font-size:x-large
}
.page {
 margin-bottom:0px
}
.bottom>div {
 height:100%
}
.summary {
 overflow:hidden
}
form {
 display:table
}
form>div {
 display:table-row
}
.interface,.top,.bottom {
 display:table-cell;
 padding:5px
}
</style><%-
 end

 content_for :onload do
-%> document.documentElement.className="noscroll";
 for (var j in eddisp.frames) $(eddisp.frames[j]).style.display="none";
 $(eddisp.frames[j]).style.display=eddisp.display[j];
 eddisp.finalfunc(eddisp.menu[j])
 toggle_frames(eddisp.menu[0])<%-
 end
-%>
<%= render "home/login" %>
<%= form_for @mediatype, :url => {:action => @action}, :html => {:class => "page"} do |m|%>
<div><%= render "home/interface" %></div>

   <div>
    <div id="mediatype_editor_actions" class="top">
     <span class="section_title"
      ><%= link_to "Mediatype", root_url + @_mediatype.url %>: <%= link_to @mediatype.title, media_path, :id => "title", :onmousedown => "if (event.which===1) stringedit(this,true);return false" %><%= m.text_field :title, :class=>"hide", :onkeypress=>"if (event.which===13) stringedit(this,false)", :onblur=>"if (this.style.display!=='none') stringedit(this,false)" %>
     </span>
     <span class="section_info">
      <span onclick="textedit(this,true)">Info</span
      ><div class="dropdown hide">
<%= m.text_area :info, :onkeypress => "if (event.which===13&&!event.shiftKey) {textedit(this.parentNode,false);return false}", :onblur => "if ((p=this.parentNode).style.display!=='none') textedit(p,false)" %></div>
     </span>
     <div id="mediatype_editor_menu" class="actions">
      <a href="#" onclick="document.forms[1].submit()">Save</a>
      <%= link_to "New", root_url + @_editor.media[0].url %>
      <a href="#" onclick="toggle_frames(this.firstChild.data)">Render</a>
      <a href="#" onclick="toggle_frames(this.firstChild.data)">Code</a>
      <a href="#" onclick="toggle_frames(this.firstChild.data)">Type</a>
     </div>
     <div id="argument_operations" class="actions">
      <a href="#" onclick="ins.call($('signature_container'))">Insert</a>
      <a href="#" onclick="del.call($('signature_container'))">Delete</a>
      <a href="#">Move</a>
     </div>
    </div>
   </div>
   <div>
    <div id="mediatype_editor_canvas" class="bottom"><%= fields_for @mediatype.data do |data| %>

     <div id="mediatype_script_frame">
<%= data.text_area :script, :class => "editor_window" %>
     </div>

     <div id="mediatype_signature_frame">
      <span style="display:<%= @mediatype.data.arguments.length>1?'block':'none' %>">Function</span>
      <ul id="signature_container" mediatype="mediatype"><%= render :partial => "media/b/argument", :collection => @mediatype.data.arguments %></ul>
      <div id="ins_stamp">Instance of
       <input class="help_text" type="text" size="50" onkeypress="if (event.which==13) ins.call(this.parentNode.parentNode,this.value.charAt(0).toUpperCase()+this.value.slice(1))"/>
      </div><%= render :partial => "media/b/argument" %>
     </div>

     <div id="mediatype_render_frame"><iframe style="display:none">Remove when document.write</iframe>
      <iframe id="mediatype_render" class="editor_window"></iframe>
     </div>

    <%- end -%></div>
   </div>
<%- end -%>
